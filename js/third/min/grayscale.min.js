var grayscale=function(){var e={colorProps:["color","backgroundColor","borderBottomColor","borderTopColor","borderLeftColor","borderRightColor","backgroundImage"],externalImageHandler:{init:function(e,t){"img"===e.nodeName.toLowerCase()||(a(e).backgroundImageSRC=t,e.style.backgroundImage="")},reset:function(e){"img"===e.nodeName.toLowerCase()||(e.style.backgroundImage="url("+(a(e).backgroundImageSRC||"")+")")}}},t=function(e){return new RegExp("https?://(?!"+window.location.hostname+")").test(e)},a=function(){var e=[0],t="data"+ +new Date;return function(a){var r=a[t],n=e.length;return r||(r=a[t]=n,e[r]={}),e[r]}}(),r=function(e,t,n){var l,i=document.createElement("canvas"),c=i.getContext("2d"),g=e.naturalHeight||e.offsetHeight||e.height,d=e.naturalWidth||e.offsetWidth||e.width;i.height=g,i.width=d,c.drawImage(e,0,0);try{l=c.getImageData(0,0,d,g)}catch(u){}if(t){r.preparing=!0;var s=0;return function(){if(r.preparing){s===g&&(c.putImageData(l,0,0,0,0,d,g),n?a(n).BGdataURL=i.toDataURL():a(e).dataURL=i.toDataURL());for(var t=0;d>t;t++){var u=4*(s*d+t);l.data[u]=l.data[u+1]=l.data[u+2]=o(l.data[u],l.data[u+1],l.data[u+2])}s++,setTimeout(arguments.callee,0)}}(),void 0}r.preparing=!1;for(var s=0;g>s;s++)for(var m=0;d>m;m++){var f=4*(s*d+m);l.data[f]=l.data[f+1]=l.data[f+2]=o(l.data[f],l.data[f+1],l.data[f+2])}return c.putImageData(l,0,0,0,0,d,g),i},n=function(e,t){var a=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null)[t]:e.currentStyle[t];if(a&&/^#[A-F0-9]/i.test(a)){var r=a.match(/[A-F0-9]{2}/gi);a="rgb("+parseInt(r[0],16)+","+parseInt(r[1],16)+","+parseInt(r[2],16)+")"}return a},o=function(e,t,a){return parseInt(.2125*e+.7154*t+.0721*a,10)},l=function(e){var t=Array.prototype.slice.call(e.getElementsByTagName("*"));return t.unshift(e),t},i=function(c){if(c&&c[0]&&c.length&&c[0].nodeName)for(var g=Array.prototype.slice.call(c),d=-1,u=g.length;++d<u;)i.call(this,g[d]);else{if(c=c||document.documentElement,!document.createElement("canvas").getContext)return c.style.filter="progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)",c.style.zoom=1,void 0;for(var s=l(c),m=-1,f=s.length;++m<f;){var v=s[m];if("img"===v.nodeName.toLowerCase()){var p=v.getAttribute("src");if(!p)continue;if(t(p))e.externalImageHandler.init(v,p);else{a(v).realSRC=p;try{v.src=a(v).dataURL||r(v).toDataURL()}catch(h){e.externalImageHandler.init(v,p)}}}else for(var y=0,I=e.colorProps.length;I>y;y++){var C=e.colorProps[y],b=n(v,C);if(b)if(v.style[C]&&(a(v)[C]=b),"rgb("!==b.substring(0,4)){if(b.indexOf("url(")>-1){var x=/\(['"]?(.+?)['"]?\)/,w=b.match(x)[1];if(t(w)){e.externalImageHandler.init(v,w),a(v).externalBG=!0;continue}try{var L=a(v).BGdataURL||function(){var e=document.createElement("img");return e.src=w,r(e).toDataURL()}();v.style[C]=b.replace(x,function(){return"("+L+")"})}catch(h){e.externalImageHandler.init(v,w)}}}else{var R=o.apply(null,b.match(/\d+/g));v.style[C]=b="rgb("+R+","+R+","+R+")"}}}}};return i.reset=function(r){if(r&&r[0]&&r.length&&r[0].nodeName)for(var n=Array.prototype.slice.call(r),o=-1,c=n.length;++o<c;)i.reset.call(this,n[o]);else{if(r=r||document.documentElement,!document.createElement("canvas").getContext)return r.style.filter="progid:DXImageTransform.Microsoft.BasicImage(grayscale=0)",void 0;for(var g=l(r),d=-1,u=g.length;++d<u;){var s=g[d];if("img"===s.nodeName.toLowerCase()){var m=s.getAttribute("src");t(m)&&e.externalImageHandler.reset(s,m),s.src=a(s).realSRC||m}else for(var f=0,v=e.colorProps.length;v>f;f++){a(s).externalBG&&e.externalImageHandler.reset(s);var p=e.colorProps[f];s.style[p]=a(s)[p]||""}}}},i.prepare=function(e){if(e&&e[0]&&e.length&&e[0].nodeName)for(var o=Array.prototype.slice.call(e),c=-1,g=o.length;++c<g;)i.prepare.call(null,o[c]);else if(e=e||document.documentElement,document.createElement("canvas").getContext)for(var d=l(e),u=-1,s=d.length;++u<s;){var m=d[u];if(a(m).skip)return;if("img"===m.nodeName.toLowerCase())m.getAttribute("src")&&!t(m.src)&&r(m,!0);else{var f=n(m,"backgroundImage");if(f.indexOf("url(")>-1){var v=/\(['"]?(.+?)['"]?\)/,p=f.match(v)[1];if(!t(p)){var h=document.createElement("img");h.src=p,r(h,!0,m)}}}}},i}();